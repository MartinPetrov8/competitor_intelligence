<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Competitor Intelligence Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,.35);
    }
    .header h1 { font-size: 1.35rem; font-weight: 700; letter-spacing: .02em; }
    .header .subtitle { font-size: .8rem; opacity: .65; margin-top: .15rem; }
    .header .logo { font-size: 1.6rem; }
    .last-updated { margin-left: auto; font-size: .75rem; opacity: .6; white-space: nowrap; }

    /* â”€â”€ Nav tabs â”€â”€ */
    .tab-bar {
      background: #fff;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      gap: 0;
      padding: 0 2rem;
      overflow-x: auto;
    }
    .tab-btn {
      padding: .75rem 1.25rem;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: .9rem;
      font-weight: 500;
      color: #64748b;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: color .15s, border-color .15s;
      white-space: nowrap;
    }
    .tab-btn:hover { color: #0f172a; }
    .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }

    /* â”€â”€ Main content â”€â”€ */
    .content { padding: 1.5rem 2rem; max-width: 1400px; margin: 0 auto; }

    /* â”€â”€ Filter bar â”€â”€ */
    .filters {
      background: #fff;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      align-items: flex-end;
      box-shadow: 0 1px 4px rgba(0,0,0,.07);
      margin-bottom: 1.25rem;
    }
    .filter-group { display: flex; flex-direction: column; gap: .25rem; }
    .filter-group label { font-size: .75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: .04em; }
    .filter-group select,
    .filter-group input[type="date"] {
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: .4rem .65rem;
      font-size: .875rem;
      background: #f8fafc;
      color: #1a1a2e;
      outline: none;
      transition: border-color .15s;
    }
    .filter-group select:focus,
    .filter-group input[type="date"]:focus { border-color: #2563eb; }
    .btn {
      padding: .45rem 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: .875rem;
      font-weight: 600;
      transition: opacity .15s, transform .1s;
    }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-primary:hover { opacity: .9; }
    .btn-secondary { background: #e2e8f0; color: #475569; }
    .btn-secondary:hover { opacity: .8; }

    /* â”€â”€ Cards â”€â”€ */
    .card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,.07);
      overflow: hidden;
      margin-bottom: 1.25rem;
    }
    .card-header {
      padding: .9rem 1.25rem;
      font-weight: 700;
      font-size: .95rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .card-body { padding: 1.25rem; }

    /* â”€â”€ Tables â”€â”€ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: .875rem; }
    thead th {
      background: #f8fafc;
      padding: .65rem 1rem;
      text-align: left;
      font-weight: 700;
      color: #475569;
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .04em;
      border-bottom: 2px solid #e2e8f0;
    }
    tbody tr { border-bottom: 1px solid #f1f5f9; transition: background .1s; }
    tbody tr:hover { background: #f8fafc; }
    tbody td { padding: .65rem 1rem; color: #1e293b; }
    .price-badge {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      font-weight: 700;
      color: #15803d;
    }
    .price-badge.high { color: #dc2626; }
    .price-badge.mid { color: #d97706; }
    .competitor-dot {
      display: inline-block;
      width: 10px; height: 10px;
      border-radius: 50%;
      margin-right: .35rem;
    }

    /* â”€â”€ Chart container â”€â”€ */
    .chart-container { position: relative; height: 300px; }

    /* â”€â”€ Loading / empty states â”€â”€ */
    .state-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 1rem;
      gap: .75rem;
      color: #94a3b8;
    }
    .state-box .icon { font-size: 2.5rem; }
    .state-box .label { font-size: .9rem; font-weight: 500; }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid #e2e8f0;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Summary chips â”€â”€ */
    .summary-bar {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      margin-bottom: 1.25rem;
    }
    .chip {
      background: #fff;
      border-radius: 8px;
      padding: .75rem 1.1rem;
      box-shadow: 0 1px 4px rgba(0,0,0,.07);
      display: flex;
      flex-direction: column;
      gap: .2rem;
      flex: 1;
      min-width: 150px;
    }
    .chip .chip-label { font-size: .72rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: .04em; }
    .chip .chip-value { font-size: 1.35rem; font-weight: 800; color: #1e293b; }
    .chip .chip-sub { font-size: .75rem; color: #94a3b8; }

    /* â”€â”€ Tab panels â”€â”€ */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* â”€â”€ Badge â”€â”€ */
    .badge {
      display: inline-block;
      padding: .15rem .5rem;
      border-radius: 999px;
      font-size: .72rem;
      font-weight: 700;
    }
    .badge-green { background: #dcfce7; color: #15803d; }
    .badge-gray { background: #f1f5f9; color: #475569; }

    /* â”€â”€ Rating star â”€â”€ */
    .rating-stars {
      color: #f59e0b;
      font-weight: 700;
      letter-spacing: .05em;
    }
    .rating-num {
      display: inline-block;
      font-weight: 800;
      color: #1e293b;
    }
    .rating-source {
      font-size: .75rem;
      color: #64748b;
      margin-left: .25rem;
    }

    /* â”€â”€ Review source tabs â”€â”€ */
    .source-tabs {
      display: flex;
      gap: .5rem;
      margin-bottom: 1rem;
    }
    .source-tab-btn {
      padding: .35rem .85rem;
      border: 1.5px solid #e2e8f0;
      border-radius: 999px;
      background: #fff;
      cursor: pointer;
      font-size: .825rem;
      font-weight: 600;
      color: #64748b;
      transition: all .15s;
    }
    .source-tab-btn.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #fff;
    }

    /* â”€â”€ Diff viewer â”€â”€ */
    .diff-item {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .diff-item-header {
      display: flex;
      align-items: center;
      gap: .75rem;
      padding: .65rem 1rem;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      flex-wrap: wrap;
    }
    .diff-item-header .competitor-name {
      font-weight: 700;
      font-size: .875rem;
      display: flex;
      align-items: center;
      gap: .35rem;
    }
    .diff-meta {
      font-size: .78rem;
      color: #64748b;
    }
    .diff-counts {
      margin-left: auto;
      display: flex;
      gap: .4rem;
    }
    .diff-add-count { color: #15803d; font-weight: 700; font-size: .78rem; }
    .diff-rem-count { color: #dc2626; font-weight: 700; font-size: .78rem; }
    .diff-body {
      display: none;
      padding: .75rem;
      background: #0f172a;
      max-height: 400px;
      overflow-y: auto;
    }
    .diff-body.expanded { display: block; }
    .diff-pre {
      font-family: "SFMono-Regular", "Fira Code", "Consolas", monospace;
      font-size: .78rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .diff-line { display: block; padding: 0 .25rem; border-radius: 2px; }
    .diff-line-add { background: rgba(21,128,61,.25); color: #86efac; }
    .diff-line-rem { background: rgba(220,38,38,.2); color: #fca5a5; }
    .diff-line-hdr { color: #93c5fd; font-weight: 700; }
    .diff-line-ctx { color: #94a3b8; }
    .diff-toggle-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: .8rem;
      color: #2563eb;
      font-weight: 600;
      padding: 0;
    }
    .diff-no-changes {
      padding: .5rem 1rem;
      font-size: .82rem;
      color: #94a3b8;
      font-style: italic;
    }

    /* â”€â”€ Products matrix â”€â”€ */
    .matrix-check { color: #15803d; font-size: 1.1rem; font-weight: 700; }
    .matrix-cross { color: #cbd5e1; font-size: 1rem; }
    .product-type-badge {
      display: inline-block;
      padding: .1rem .45rem;
      border-radius: 5px;
      font-size: .72rem;
      font-weight: 600;
      background: #eff6ff;
      color: #2563eb;
      margin-left: .3rem;
    }

    /* â”€â”€ Review trend layout â”€â”€ */
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.25rem;
    }
    @media (max-width: 900px) {
      .charts-row { grid-template-columns: 1fr; }
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 640px) {
      .content { padding: 1rem; }
      .header { padding: .75rem 1rem; }
      .tab-bar { padding: 0 1rem; }
      .chip .chip-value { font-size: 1.1rem; }
    }
  </style>
</head>
<body>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="header">
  <div class="logo">ğŸ“Š</div>
  <div>
    <div class="header h1">Competitor Intelligence Tracker</div>
    <div class="subtitle">DummyVisaTicket â€” Daily monitoring dashboard</div>
  </div>
  <div class="last-updated" id="lastUpdated"></div>
</header>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tab bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav class="tab-bar" role="tablist">
  <button class="tab-btn active" data-tab="pricing" role="tab" aria-selected="true">ğŸ’° Pricing</button>
  <button class="tab-btn" data-tab="products" role="tab" aria-selected="false">ğŸ“¦ Products</button>
  <button class="tab-btn" data-tab="reviews" role="tab" aria-selected="false">â­ Reviews</button>
  <button class="tab-btn" data-tab="diffs" role="tab" aria-selected="false">ğŸ”„ Site Diffs</button>
  <button class="tab-btn" data-tab="abtests" role="tab" aria-selected="false">ğŸ§ª A/B Tests</button>
</nav>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main class="content">

  <!-- â•â•â•â• PRICING TAB â•â•â•â• -->
  <section class="tab-panel active" id="tab-pricing">

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="filterCompetitor">Competitor</label>
        <select id="filterCompetitor">
          <option value="">All competitors</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filterDateFrom">From</label>
        <input type="date" id="filterDateFrom" />
      </div>
      <div class="filter-group">
        <label for="filterDateTo">To</label>
        <input type="date" id="filterDateTo" />
      </div>
      <div class="filter-group">
        <label for="filterProduct">Product</label>
        <select id="filterProduct">
          <option value="">All products</option>
        </select>
      </div>
      <button class="btn btn-primary" id="applyFilters">Apply</button>
      <button class="btn btn-secondary" id="resetFilters">Reset</button>
    </div>

    <!-- Summary chips -->
    <div class="summary-bar" id="pricingSummary"></div>

    <!-- Latest prices table -->
    <div class="card" id="priceTableCard">
      <div class="card-header">
        ğŸ“‹ Latest Prices
        <span class="badge badge-gray" id="priceRowCount" style="margin-left:auto;">â€”</span>
      </div>
      <div class="card-body">
        <div id="priceTableState" class="state-box">
          <div class="spinner"></div>
          <div class="label">Loading pricing dataâ€¦</div>
        </div>
        <div class="table-wrap" id="priceTableWrap" style="display:none;">
          <table id="priceTable" aria-label="Competitor pricing table">
            <thead>
              <tr>
                <th>Competitor</th>
                <th>Date</th>
                <th>Product</th>
                <th>Tier</th>
                <th>Price</th>
                <th>Bundle</th>
              </tr>
            </thead>
            <tbody id="priceTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Trend chart -->
    <div class="card">
      <div class="card-header">ğŸ“ˆ Price Trend Over Time</div>
      <div class="card-body">
        <div id="chartState" class="state-box" style="display:none;">
          <div class="icon">ğŸ“‰</div>
          <div class="label">No trend data available for the selected filters.</div>
        </div>
        <div class="chart-container" id="chartWrap">
          <canvas id="priceTrendChart" aria-label="Price trend line chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Comparison matrix: latest price per competitor Ã— product -->
    <div class="card">
      <div class="card-header">ğŸ—‚ï¸ Competitor Ã— Product Comparison</div>
      <div class="card-body">
        <div id="matrixState" class="state-box" style="display:none;">
          <div class="icon">ğŸ”</div>
          <div class="label">No comparison data available.</div>
        </div>
        <div class="table-wrap" id="matrixWrap" style="display:none;">
          <table id="matrixTable" aria-label="Competitor product comparison matrix">
            <thead id="matrixHead"></thead>
            <tbody id="matrixBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </section>

  <!-- â•â•â•â• PRODUCTS TAB â•â•â•â• -->
  <section class="tab-panel" id="tab-products">

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="productsFilterCompetitor">Competitor</label>
        <select id="productsFilterCompetitor">
          <option value="">All competitors</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="productsFilterDate">Date</label>
        <input type="date" id="productsFilterDate" />
      </div>
      <button class="btn btn-primary" id="productsApplyFilters">Apply</button>
      <button class="btn btn-secondary" id="productsResetFilters">Reset</button>
    </div>

    <!-- Product comparison matrix -->
    <div class="card">
      <div class="card-header">
        ğŸ“¦ Product Comparison Matrix
        <span class="badge badge-gray" id="productsRowCount" style="margin-left:auto;">â€”</span>
      </div>
      <div class="card-body">
        <div id="productsMatrixState" class="state-box">
          <div class="spinner"></div>
          <div class="label">Loading productsâ€¦</div>
        </div>
        <div class="table-wrap" id="productsMatrixWrap" style="display:none;">
          <table id="productsMatrixTable" aria-label="Products comparison matrix">
            <thead id="productsMatrixHead"></thead>
            <tbody id="productsMatrixBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Full product catalog table -->
    <div class="card">
      <div class="card-header">ğŸ“‹ Full Product Catalog</div>
      <div class="card-body">
        <div id="productsCatalogState" class="state-box" style="display:none;">
          <div class="icon">ğŸ”</div>
          <div class="label">No product data found.</div>
        </div>
        <div class="table-wrap" id="productsCatalogWrap" style="display:none;">
          <table id="productsTable" aria-label="Products catalog table">
            <thead>
              <tr>
                <th>Competitor</th>
                <th>Date</th>
                <th>Product</th>
                <th>Type</th>
                <th>Description</th>
                <th>Bundle</th>
              </tr>
            </thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </section>

  <!-- â•â•â•â• REVIEWS TAB â•â•â•â• -->
  <section class="tab-panel" id="tab-reviews">

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="reviewsFilterCompetitor">Competitor</label>
        <select id="reviewsFilterCompetitor">
          <option value="">All competitors</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="reviewsFilterFrom">From</label>
        <input type="date" id="reviewsFilterFrom" />
      </div>
      <div class="filter-group">
        <label for="reviewsFilterTo">To</label>
        <input type="date" id="reviewsFilterTo" />
      </div>
      <button class="btn btn-primary" id="reviewsApplyFilters">Apply</button>
      <button class="btn btn-secondary" id="reviewsResetFilters">Reset</button>
    </div>

    <!-- Source selector -->
    <div class="source-tabs" id="reviewsSourceTabs" role="tablist" aria-label="Review source">
      <button class="source-tab-btn active" data-source="trustpilot" role="tab" aria-selected="true">Trustpilot</button>
      <button class="source-tab-btn" data-source="google" role="tab" aria-selected="false">Google</button>
    </div>

    <!-- Trend charts -->
    <div class="charts-row">
      <div class="card" style="margin-bottom:0;">
        <div class="card-header">â­ Rating Trend</div>
        <div class="card-body">
          <div id="reviewsRatingChartState" class="state-box" style="display:none;">
            <div class="icon">ğŸ“‰</div>
            <div class="label">No rating data available.</div>
          </div>
          <div class="chart-container" id="reviewsRatingChartWrap">
            <canvas id="reviewsRatingChart" aria-label="Review rating trend chart"></canvas>
          </div>
        </div>
      </div>
      <div class="card" style="margin-bottom:0;">
        <div class="card-header">ğŸ’¬ Review Count Trend</div>
        <div class="card-body">
          <div id="reviewsCountChartState" class="state-box" style="display:none;">
            <div class="icon">ğŸ“‰</div>
            <div class="label">No review count data available.</div>
          </div>
          <div class="chart-container" id="reviewsCountChartWrap">
            <canvas id="reviewsCountChart" aria-label="Review count trend chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div style="margin-bottom:1.25rem;"></div>

    <!-- Ratings table -->
    <div class="card">
      <div class="card-header">
        ğŸ“‹ Latest Ratings
        <span class="badge badge-gray" id="reviewsRowCount" style="margin-left:auto;">â€”</span>
      </div>
      <div class="card-body">
        <div id="reviewsTableState" class="state-box">
          <div class="spinner"></div>
          <div class="label">Loading reviewsâ€¦</div>
        </div>
        <div class="table-wrap" id="reviewsTableWrap" style="display:none;">
          <table id="reviewsTable" aria-label="Review metrics table">
            <thead>
              <tr>
                <th>Competitor</th>
                <th>Date</th>
                <th>Rating</th>
                <th>Reviews</th>
                <th>Source</th>
              </tr>
            </thead>
            <tbody id="reviewsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </section>

  <!-- â•â•â•â• DIFFS TAB â•â•â•â• -->
  <section class="tab-panel" id="tab-diffs">

    <!-- Filters -->
    <div class="filters">
      <div class="filter-group">
        <label for="diffsFilterCompetitor">Competitor</label>
        <select id="diffsFilterCompetitor">
          <option value="">All competitors</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="diffsFilterFrom">From</label>
        <input type="date" id="diffsFilterFrom" />
      </div>
      <div class="filter-group">
        <label for="diffsFilterTo">To</label>
        <input type="date" id="diffsFilterTo" />
      </div>
      <button class="btn btn-primary" id="diffsApplyFilters">Apply</button>
      <button class="btn btn-secondary" id="diffsResetFilters">Reset</button>
    </div>

    <!-- Diffs list -->
    <div class="card">
      <div class="card-header">
        ğŸ”„ Website Changes
        <span class="badge badge-gray" id="diffsCount" style="margin-left:auto;">â€”</span>
      </div>
      <div class="card-body" id="diffsCardBody">
        <div id="diffsState" class="state-box">
          <div class="spinner"></div>
          <div class="label">Loading diffsâ€¦</div>
        </div>
        <div id="diffsList"></div>
      </div>
    </div>

  </section>

  <!-- â•â•â•â• A/B TESTS TAB â•â•â•â• -->
  <section class="tab-panel" id="tab-abtests">
    <div class="card">
      <div class="card-header">ğŸ§ª A/B Test Detection</div>
      <div class="card-body">
        <div class="state-box" id="abtestsPlaceholder">
          <div class="icon">ğŸš§</div>
          <div class="label">A/B test detection view â€” coming in next release</div>
        </div>
      </div>
    </div>
  </section>

</main>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Competitor Intelligence Dashboard
   Vanilla JS, Chart.js 4
   Tabs: Pricing | Products | Reviews | Diffs | A/B Tests
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Competitor colour palette â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = [
  '#2563eb', '#16a34a', '#dc2626', '#9333ea', '#d97706',
  '#0891b2', '#db2777', '#65a30d',
];
let colorMap = {};

function competitorColor(domain) {
  if (!colorMap[domain]) {
    const idx = Object.keys(colorMap).length % COLORS.length;
    colorMap[domain] = COLORS[idx];
  }
  return colorMap[domain];
}

// â”€â”€ Date helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function today() {
  return new Date().toISOString().slice(0, 10);
}
function daysAgo(n) {
  const d = new Date();
  d.setDate(d.getDate() - n);
  return d.toISOString().slice(0, 10);
}

// â”€â”€ API calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status} â€” ${url}`);
  return res.json();
}

function buildURL(base, params) {
  const qs = new URLSearchParams();
  if (params.competitor) qs.set('competitor', params.competitor);
  if (params.date)       qs.set('date', params.date);
  if (params.startDate)  qs.set('start_date', params.startDate);
  if (params.endDate)    qs.set('end_date', params.endDate);
  const q = qs.toString();
  return base + (q ? '?' + q : '');
}

// â”€â”€ Chart registry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const charts = {};

function destroyChart(id) {
  if (charts[id]) {
    charts[id].destroy();
    delete charts[id];
  }
}

function createLineChart(canvasId, labels, datasets, yTickCb) {
  destroyChart(canvasId);
  const ctx = document.getElementById(canvasId).getContext('2d');
  charts[canvasId] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top', labels: { usePointStyle: true, boxWidth: 10 } },
      },
      scales: {
        x: {
          grid: { color: '#f1f5f9' },
          ticks: { font: { size: 11 }, maxRotation: 45 },
        },
        y: {
          grid: { color: '#f1f5f9' },
          ticks: { font: { size: 11 }, callback: yTickCb },
          beginAtZero: false,
        }
      }
    }
  });
}

// â”€â”€ Escape helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}
function escAttr(str) {
  return String(str).replace(/"/g, '&quot;');
}

// â”€â”€ Competitor filter population â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateCompetitorFilter(selectId, competitors) {
  const sel = document.getElementById(selectId);
  if (!sel) return;
  const current = sel.value;
  sel.innerHTML = '<option value="">All competitors</option>' +
    competitors.map(c => `<option value="${escAttr(c.domain)}"${c.domain === current ? ' selected' : ''}>${escHtml(c.domain)}</option>`).join('');
}

let allCompetitors = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICING TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buildPriceURL(params) {
  return buildURL('/api/prices', params);
}

function renderSummary(rows) {
  const el = document.getElementById('pricingSummary');
  if (!rows.length) { el.innerHTML = ''; return; }

  const competitors = [...new Set(rows.map(r => r.competitor))];
  const prices = rows.map(r => r.price_amount).filter(p => p != null);
  const minPrice = prices.length ? Math.min(...prices) : null;
  const maxPrice = prices.length ? Math.max(...prices) : null;
  const dates = [...new Set(rows.map(r => r.scrape_date))].sort();

  el.innerHTML = `
    <div class="chip">
      <div class="chip-label">Competitors</div>
      <div class="chip-value">${competitors.length}</div>
      <div class="chip-sub">tracked</div>
    </div>
    <div class="chip">
      <div class="chip-label">Price records</div>
      <div class="chip-value">${rows.length.toLocaleString()}</div>
      <div class="chip-sub">total rows</div>
    </div>
    <div class="chip">
      <div class="chip-label">Lowest price</div>
      <div class="chip-value">${minPrice != null ? '$' + minPrice.toFixed(2) : 'â€”'}</div>
      <div class="chip-sub">across all</div>
    </div>
    <div class="chip">
      <div class="chip-label">Highest price</div>
      <div class="chip-value">${maxPrice != null ? '$' + maxPrice.toFixed(2) : 'â€”'}</div>
      <div class="chip-sub">across all</div>
    </div>
    <div class="chip">
      <div class="chip-label">Date range</div>
      <div class="chip-value" style="font-size:.95rem;">${dates[0] || 'â€”'}</div>
      <div class="chip-sub">â†’ ${dates[dates.length - 1] || 'â€”'}</div>
    </div>
  `;
}

function renderPriceTable(rows) {
  const stateEl  = document.getElementById('priceTableState');
  const wrapEl   = document.getElementById('priceTableWrap');
  const bodyEl   = document.getElementById('priceTableBody');
  const countEl  = document.getElementById('priceRowCount');

  if (!rows.length) {
    wrapEl.style.display = 'none';
    stateEl.style.display = 'flex';
    stateEl.innerHTML = `
      <div class="icon">ğŸ”</div>
      <div class="label">No pricing data found for the selected filters.</div>`;
    countEl.textContent = '0 rows';
    return;
  }

  stateEl.style.display = 'none';
  wrapEl.style.display  = 'block';
  countEl.textContent   = rows.length + ' row' + (rows.length !== 1 ? 's' : '');

  bodyEl.innerHTML = rows.map(r => {
    const color  = competitorColor(r.competitor);
    const price  = r.price_amount != null ? parseFloat(r.price_amount) : null;
    const pClass = price == null ? '' : price > 30 ? 'high' : price > 15 ? 'mid' : '';
    const pText  = price != null ? `${r.currency || '$'}&nbsp;${price.toFixed(2)}` : 'â€”';
    return `<tr>
      <td>
        <span class="competitor-dot" style="background:${color}"></span>
        ${escHtml(r.competitor)}
      </td>
      <td>${escHtml(r.scrape_date || '')}</td>
      <td>${escHtml(r.product_name || 'â€”')}</td>
      <td>${escHtml(r.tier_name   || 'â€”')}</td>
      <td><span class="price-badge ${pClass}">${pText}</span></td>
      <td>${escHtml(r.bundle_info || 'â€”')}</td>
    </tr>`;
  }).join('');
}

function renderTrendChart(rows) {
  const chartWrap  = document.getElementById('chartWrap');
  const chartState = document.getElementById('chartState');
  destroyChart('priceTrendChart');

  const byCompetitor = {};
  for (const r of rows) {
    if (r.price_amount == null) continue;
    if (!byCompetitor[r.competitor]) byCompetitor[r.competitor] = {};
    const d = r.scrape_date;
    if (!byCompetitor[r.competitor][d]) byCompetitor[r.competitor][d] = [];
    byCompetitor[r.competitor][d].push(parseFloat(r.price_amount));
  }

  const competitors = Object.keys(byCompetitor);
  if (!competitors.length) {
    chartWrap.style.display  = 'none';
    chartState.style.display = 'flex';
    return;
  }

  chartState.style.display = 'none';
  chartWrap.style.display  = 'block';

  const allDates = [...new Set(rows.map(r => r.scrape_date).filter(Boolean))].sort();

  const datasets = competitors.map(comp => {
    const color = competitorColor(comp);
    const data = allDates.map(date => {
      const prices = byCompetitor[comp][date];
      if (!prices || !prices.length) return null;
      return prices.reduce((a, b) => a + b, 0) / prices.length;
    });
    return {
      label: comp,
      data,
      borderColor: color,
      backgroundColor: color + '22',
      fill: false,
      tension: 0.35,
      pointRadius: 4,
      pointHoverRadius: 6,
      spanGaps: true,
    };
  });

  createLineChart('priceTrendChart', allDates, datasets, v => '$' + v.toFixed(2));
}

function renderComparisonMatrix(rows) {
  const wrapEl  = document.getElementById('matrixWrap');
  const stateEl = document.getElementById('matrixState');
  const headEl  = document.getElementById('matrixHead');
  const bodyEl  = document.getElementById('matrixBody');

  if (!rows.length) {
    wrapEl.style.display  = 'none';
    stateEl.style.display = 'flex';
    return;
  }

  const products = [...new Set(rows.map(r => r.product_name).filter(Boolean))].sort();
  const competitors = [...new Set(rows.map(r => r.competitor))].sort();

  const cell = {};
  for (const r of rows) {
    if (!r.product_name) continue;
    if (!cell[r.product_name]) cell[r.product_name] = {};
    const prev = cell[r.product_name][r.competitor];
    if (!prev || r.scrape_date > (prev.date || '')) {
      cell[r.product_name][r.competitor] = { price: r.price_amount, date: r.scrape_date };
    }
  }

  if (!products.length || !competitors.length) {
    wrapEl.style.display  = 'none';
    stateEl.style.display = 'flex';
    return;
  }

  stateEl.style.display = 'none';
  wrapEl.style.display  = 'block';

  headEl.innerHTML = `<tr>
    <th>Product</th>
    ${competitors.map(c => `<th><span class="competitor-dot" style="background:${competitorColor(c)}"></span>${escHtml(c)}</th>`).join('')}
  </tr>`;

  bodyEl.innerHTML = products.map(prod => {
    const cells = competitors.map(comp => {
      const entry = cell[prod] && cell[prod][comp];
      if (!entry || entry.price == null) return '<td style="color:#94a3b8">â€”</td>';
      const p = parseFloat(entry.price);
      const cls = p > 30 ? 'high' : p > 15 ? 'mid' : '';
      return `<td><span class="price-badge ${cls}">$${p.toFixed(2)}</span></td>`;
    }).join('');
    return `<tr><td style="font-weight:600;">${escHtml(prod)}</td>${cells}</tr>`;
  }).join('');
}

function populateProductFilter(rows) {
  const sel = document.getElementById('filterProduct');
  const current = sel.value;
  const products = [...new Set(rows.map(r => r.product_name).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">All products</option>' +
    products.map(p => `<option value="${escAttr(p)}"${p === current ? ' selected' : ''}>${escHtml(p)}</option>`).join('');
}

async function loadAndRender() {
  document.getElementById('priceTableState').style.display = 'flex';
  document.getElementById('priceTableState').innerHTML = `<div class="spinner"></div><div class="label">Loadingâ€¦</div>`;
  document.getElementById('priceTableWrap').style.display = 'none';

  const params = {
    competitor: document.getElementById('filterCompetitor').value || '',
    startDate:  document.getElementById('filterDateFrom').value  || '',
    endDate:    document.getElementById('filterDateTo').value    || '',
  };

  let rows = [];
  try {
    rows = await fetchJSON(buildPriceURL(params));
    document.getElementById('lastUpdated').textContent =
      'Loaded ' + new Date().toLocaleTimeString();
  } catch (err) {
    document.getElementById('priceTableState').style.display = 'flex';
    document.getElementById('priceTableState').innerHTML = `
      <div class="icon">âš ï¸</div>
      <div class="label">Failed to load data: ${escHtml(String(err))}</div>`;
    console.error('Price load error:', err);
    return;
  }

  const productFilter = document.getElementById('filterProduct').value;
  let filteredRows = rows;
  if (productFilter) {
    filteredRows = rows.filter(r => r.product_name === productFilter);
  }

  populateProductFilter(rows);
  renderSummary(filteredRows);
  renderPriceTable(filteredRows);
  renderTrendChart(filteredRows);
  renderComparisonMatrix(filteredRows);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderProductsMatrix(rows) {
  const wrapEl  = document.getElementById('productsMatrixWrap');
  const stateEl = document.getElementById('productsMatrixState');
  const headEl  = document.getElementById('productsMatrixHead');
  const bodyEl  = document.getElementById('productsMatrixBody');
  const countEl = document.getElementById('productsRowCount');

  if (!rows.length) {
    wrapEl.style.display  = 'none';
    stateEl.style.display = 'flex';
    stateEl.innerHTML = `<div class="icon">ğŸ”</div><div class="label">No product data found.</div>`;
    countEl.textContent = '0 rows';
    return;
  }

  // Use the most recent scrape per competitor
  const latestDate = {};
  for (const r of rows) {
    if (!latestDate[r.competitor] || r.scrape_date > latestDate[r.competitor]) {
      latestDate[r.competitor] = r.scrape_date;
    }
  }
  const latestRows = rows.filter(r => r.scrape_date === latestDate[r.competitor]);

  const competitors = [...new Set(latestRows.map(r => r.competitor))].sort();
  const products    = [...new Set(latestRows.map(r => r.product_name).filter(Boolean))].sort();

  // cell[product][competitor] = { type, is_bundle }
  const cell = {};
  for (const r of latestRows) {
    if (!r.product_name) continue;
    if (!cell[r.product_name]) cell[r.product_name] = {};
    cell[r.product_name][r.competitor] = {
      type: r.product_type || '',
      is_bundle: r.is_bundle,
    };
  }

  countEl.textContent = rows.length + ' records';
  stateEl.style.display = 'none';
  wrapEl.style.display  = 'block';

  headEl.innerHTML = `<tr>
    <th>Product / Service</th>
    ${competitors.map(c =>
      `<th><span class="competitor-dot" style="background:${competitorColor(c)}"></span>${escHtml(c)}</th>`
    ).join('')}
  </tr>`;

  bodyEl.innerHTML = products.map(prod => {
    const cells = competitors.map(comp => {
      const entry = cell[prod] && cell[prod][comp];
      if (!entry) return `<td><span class="matrix-cross">âœ—</span></td>`;
      const typeBadge = entry.type
        ? `<span class="product-type-badge">${escHtml(entry.type)}</span>` : '';
      return `<td><span class="matrix-check">âœ“</span>${typeBadge}</td>`;
    }).join('');
    return `<tr><td style="font-weight:600;">${escHtml(prod)}</td>${cells}</tr>`;
  }).join('');
}

function renderProductsCatalog(rows) {
  const wrapEl  = document.getElementById('productsCatalogWrap');
  const stateEl = document.getElementById('productsCatalogState');
  const bodyEl  = document.getElementById('productsTableBody');

  if (!rows.length) {
    wrapEl.style.display  = 'none';
    stateEl.style.display = 'flex';
    return;
  }

  stateEl.style.display = 'none';
  wrapEl.style.display  = 'block';

  bodyEl.innerHTML = rows.map(r => {
    const color = competitorColor(r.competitor);
    const bundleBadge = r.is_bundle
      ? `<span class="badge badge-green">Bundle</span>`
      : `<span class="badge badge-gray">Single</span>`;
    return `<tr>
      <td><span class="competitor-dot" style="background:${color}"></span>${escHtml(r.competitor)}</td>
      <td>${escHtml(r.scrape_date || '')}</td>
      <td style="font-weight:600;">${escHtml(r.product_name || 'â€”')}</td>
      <td>${escHtml(r.product_type || 'â€”')}</td>
      <td style="max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escAttr(r.description || '')}">${escHtml(r.description || 'â€”')}</td>
      <td>${bundleBadge}</td>
    </tr>`;
  }).join('');
}

async function loadAndRenderProducts() {
  document.getElementById('productsMatrixState').style.display = 'flex';
  document.getElementById('productsMatrixState').innerHTML = `<div class="spinner"></div><div class="label">Loadingâ€¦</div>`;
  document.getElementById('productsMatrixWrap').style.display = 'none';
  document.getElementById('productsCatalogState').style.display = 'none';
  document.getElementById('productsCatalogWrap').style.display = 'none';

  const params = {
    competitor: document.getElementById('productsFilterCompetitor').value || '',
    date:       document.getElementById('productsFilterDate').value || '',
  };

  let rows = [];
  try {
    rows = await fetchJSON(buildURL('/api/products', params));
  } catch (err) {
    document.getElementById('productsMatrixState').style.display = 'flex';
    document.getElementById('productsMatrixState').innerHTML = `
      <div class="icon">âš ï¸</div>
      <div class="label">Failed to load products: ${escHtml(String(err))}</div>`;
    console.error('Products load error:', err);
    return;
  }

  renderProductsMatrix(rows);
  renderProductsCatalog(rows);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REVIEWS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let activeReviewSource = 'trustpilot';

function renderReviewsTable(rows, source) {
  const stateEl = document.getElementById('reviewsTableState');
  const wrapEl  = document.getElementById('reviewsTableWrap');
  const bodyEl  = document.getElementById('reviewsTableBody');
  const countEl = document.getElementById('reviewsRowCount');

  if (!rows.length) {
    wrapEl.style.display = 'none';
    stateEl.style.display = 'flex';
    stateEl.innerHTML = `<div class="icon">ğŸ”</div><div class="label">No review data found.</div>`;
    countEl.textContent = '0 rows';
    return;
  }

  stateEl.style.display = 'none';
  wrapEl.style.display  = 'block';
  countEl.textContent   = rows.length + ' row' + (rows.length !== 1 ? 's' : '');

  bodyEl.innerHTML = rows.map(r => {
    const color  = competitorColor(r.competitor);
    const rating = r.overall_rating != null ? parseFloat(r.overall_rating).toFixed(1) : 'â€”';
    const count  = r.total_reviews  != null ? Number(r.total_reviews).toLocaleString() : 'â€”';
    const stars  = r.overall_rating != null ? renderStars(parseFloat(r.overall_rating)) : '';
    return `<tr>
      <td><span class="competitor-dot" style="background:${color}"></span>${escHtml(r.competitor)}</td>
      <td>${escHtml(r.scrape_date || '')}</td>
      <td>
        <span class="rating-num">${rating}</span>
        <span class="rating-stars">${stars}</span>
      </td>
      <td>${count}</td>
      <td><span class="badge badge-gray">${escHtml(source)}</span></td>
    </tr>`;
  }).join('');
}

function renderStars(rating) {
  const full  = Math.floor(rating);
  const half  = rating - full >= 0.5 ? 1 : 0;
  const empty = 5 - full - half;
  return 'â˜…'.repeat(full) + (half ? 'Â½' : '') + 'â˜†'.repeat(empty);
}

function renderReviewsRatingChart(rows) {
  const wrapEl  = document.getElementById('reviewsRatingChartWrap');
  const stateEl = document.getElementById('reviewsRatingChartState');
  destroyChart('reviewsRatingChart');

  const byComp = {};
  for (const r of rows) {
    if (r.overall_rating == null) continue;
    if (!byComp[r.competitor]) byComp[r.competitor] = {};
    byComp[r.competitor][r.scrape_date] = parseFloat(r.overall_rating);
  }

  const competitors = Object.keys(byComp);
  if (!competitors.length) {
    wrapEl.style.display  = 'none';
    stateEl.style.display = 'flex';
    return;
  }

  stateEl.style.display = 'none';
  wrapEl.style.display  = 'block';

  const allDates = [...new Set(rows.map(r => r.scrape_date).filter(Boolean))].sort();
  const datasets = competitors.map(comp => {
    const color = competitorColor(comp);
    return {
      label: comp,
      data: allDates.map(d => byComp[comp][d] ?? null),
      borderColor: color,
      backgroundColor: color + '22',
      fill: false,
      tension: 0.35,
      pointRadius: 4,
      pointHoverRadius: 6,
      spanGaps: true,
    };
  });

  createLineChart('reviewsRatingChart', allDates, datasets, v => v.toFixed(1) + 'â˜…');
}

function renderReviewsCountChart(rows) {
  const wrapEl  = document.getElementById('reviewsCountChartWrap');
  const stateEl = document.getElementById('reviewsCountChartState');
  destroyChart('reviewsCountChart');

  const byComp = {};
  for (const r of rows) {
    if (r.total_reviews == null) continue;
    if (!byComp[r.competitor]) byComp[r.competitor] = {};
    byComp[r.competitor][r.scrape_date] = Number(r.total_reviews);
  }

  const competitors = Object.keys(byComp);
  if (!competitors.length) {
    wrapEl.style.display  = 'none';
    stateEl.style.display = 'flex';
    return;
  }

  stateEl.style.display = 'none';
  wrapEl.style.display  = 'block';

  const allDates = [...new Set(rows.map(r => r.scrape_date).filter(Boolean))].sort();
  const datasets = competitors.map(comp => {
    const color = competitorColor(comp);
    return {
      label: comp,
      data: allDates.map(d => byComp[comp][d] ?? null),
      borderColor: color,
      backgroundColor: color + '22',
      fill: false,
      tension: 0.35,
      pointRadius: 4,
      pointHoverRadius: 6,
      spanGaps: true,
    };
  });

  createLineChart('reviewsCountChart', allDates, datasets, v => v.toLocaleString());
}

async function loadAndRenderReviews() {
  document.getElementById('reviewsTableState').style.display = 'flex';
  document.getElementById('reviewsTableState').innerHTML = `<div class="spinner"></div><div class="label">Loadingâ€¦</div>`;
  document.getElementById('reviewsTableWrap').style.display = 'none';

  const params = {
    competitor: document.getElementById('reviewsFilterCompetitor').value || '',
    startDate:  document.getElementById('reviewsFilterFrom').value || '',
    endDate:    document.getElementById('reviewsFilterTo').value   || '',
  };

  let data = { trustpilot: [], google: [] };
  try {
    data = await fetchJSON(buildURL('/api/reviews', params));
  } catch (err) {
    document.getElementById('reviewsTableState').style.display = 'flex';
    document.getElementById('reviewsTableState').innerHTML = `
      <div class="icon">âš ï¸</div>
      <div class="label">Failed to load reviews: ${escHtml(String(err))}</div>`;
    console.error('Reviews load error:', err);
    return;
  }

  const rows = data[activeReviewSource] || [];
  renderReviewsTable(rows, activeReviewSource);
  renderReviewsRatingChart(rows);
  renderReviewsCountChart(rows);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIFFS TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderDiffLine(line) {
  const esc = escHtml(line);
  if (line.startsWith('+++') || line.startsWith('---')) {
    return `<span class="diff-line diff-line-hdr">${esc}</span>`;
  }
  if (line.startsWith('@@')) {
    return `<span class="diff-line diff-line-hdr">${esc}</span>`;
  }
  if (line.startsWith('+')) {
    return `<span class="diff-line diff-line-add">${esc}</span>`;
  }
  if (line.startsWith('-')) {
    return `<span class="diff-line diff-line-rem">${esc}</span>`;
  }
  return `<span class="diff-line diff-line-ctx">${esc}</span>`;
}

function renderDiffText(diffText) {
  if (!diffText || !diffText.trim()) {
    return `<div class="diff-no-changes">No textual changes detected.</div>`;
  }
  const lines = diffText.split('\n');
  return `<div class="diff-body" id="diffBody_${Math.random().toString(36).slice(2)}">
    <pre class="diff-pre">${lines.map(renderDiffLine).join('\n')}</pre>
  </div>`;
}

function renderDiffsList(rows) {
  const stateEl  = document.getElementById('diffsState');
  const listEl   = document.getElementById('diffsList');
  const countEl  = document.getElementById('diffsCount');

  if (!rows.length) {
    stateEl.style.display = 'flex';
    stateEl.innerHTML = `<div class="icon">ğŸ”</div><div class="label">No diff records found.</div>`;
    listEl.innerHTML = '';
    countEl.textContent = '0 diffs';
    return;
  }

  stateEl.style.display = 'none';
  countEl.textContent = rows.length + ' diff' + (rows.length !== 1 ? 's' : '');

  listEl.innerHTML = rows.map((r, idx) => {
    const color     = competitorColor(r.competitor);
    const addCount  = r.additions_count != null ? r.additions_count : '?';
    const remCount  = r.removals_count  != null ? r.removals_count  : '?';
    const bodyId    = `diffBody_${idx}`;
    const hasDiff   = r.diff_text && r.diff_text.trim();

    const diffBodyHtml = hasDiff
      ? `<div class="diff-body" id="${bodyId}">
           <pre class="diff-pre">${r.diff_text.split('\n').map(renderDiffLine).join('\n')}</pre>
         </div>`
      : `<div class="diff-no-changes">No textual changes detected.</div>`;

    return `<div class="diff-item" id="diffItem_${idx}">
      <div class="diff-item-header">
        <div class="competitor-name">
          <span class="competitor-dot" style="background:${color}"></span>
          ${escHtml(r.competitor)}
        </div>
        <span class="diff-meta">${escHtml(r.diff_date || '')} Â· ${escHtml(r.page_type || 'homepage')}</span>
        <div class="diff-counts">
          <span class="diff-add-count">+${addCount} additions</span>
          <span class="diff-rem-count">-${remCount} removals</span>
        </div>
        ${hasDiff ? `<button class="diff-toggle-btn" data-body="${bodyId}" onclick="toggleDiff(this)">â–¼ Show diff</button>` : ''}
      </div>
      ${diffBodyHtml}
    </div>`;
  }).join('');
}

function toggleDiff(btn) {
  const bodyId = btn.getAttribute('data-body');
  const body   = document.getElementById(bodyId);
  if (!body) return;
  const expanded = body.classList.toggle('expanded');
  btn.textContent = expanded ? 'â–² Hide diff' : 'â–¼ Show diff';
}

async function loadAndRenderDiffs() {
  document.getElementById('diffsState').style.display = 'flex';
  document.getElementById('diffsState').innerHTML = `<div class="spinner"></div><div class="label">Loadingâ€¦</div>`;
  document.getElementById('diffsList').innerHTML = '';

  const params = {
    competitor: document.getElementById('diffsFilterCompetitor').value || '',
    startDate:  document.getElementById('diffsFilterFrom').value || '',
    endDate:    document.getElementById('diffsFilterTo').value   || '',
  };

  let rows = [];
  try {
    rows = await fetchJSON(buildURL('/api/diffs', params));
  } catch (err) {
    document.getElementById('diffsState').style.display = 'flex';
    document.getElementById('diffsState').innerHTML = `
      <div class="icon">âš ï¸</div>
      <div class="label">Failed to load diffs: ${escHtml(String(err))}</div>`;
    console.error('Diffs load error:', err);
    return;
  }

  renderDiffsList(rows);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const tabLoaded = {};

function switchTab(tabName) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === tabName);
    b.setAttribute('aria-selected', b.dataset.tab === tabName ? 'true' : 'false');
  });
  document.querySelectorAll('.tab-panel').forEach(p => {
    p.classList.toggle('active', p.id === 'tab-' + tabName);
  });

  // Lazy-load on first visit (or always for pricing which has its own apply button)
  if (!tabLoaded[tabName]) {
    tabLoaded[tabName] = true;
    if (tabName === 'products') loadAndRenderProducts();
    if (tabName === 'reviews')  loadAndRenderReviews();
    if (tabName === 'diffs')    loadAndRenderDiffs();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function init() {
  // Default date range: last 30 days
  const defaultFrom = daysAgo(30);
  const defaultTo   = today();

  document.getElementById('filterDateFrom').value   = defaultFrom;
  document.getElementById('filterDateTo').value     = defaultTo;
  document.getElementById('reviewsFilterFrom').value = defaultFrom;
  document.getElementById('reviewsFilterTo').value   = defaultTo;
  document.getElementById('diffsFilterFrom').value   = defaultFrom;
  document.getElementById('diffsFilterTo').value     = defaultTo;

  // Load competitors for all dropdowns
  try {
    allCompetitors = await fetchJSON('/api/competitors');
    ['filterCompetitor', 'productsFilterCompetitor', 'reviewsFilterCompetitor', 'diffsFilterCompetitor'].forEach(id => {
      populateCompetitorFilter(id, allCompetitors);
    });
  } catch (e) {
    console.warn('Could not load competitors:', e);
  }

  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
  });

  // â”€â”€ Pricing filters â”€â”€
  document.getElementById('applyFilters').addEventListener('click', loadAndRender);
  document.getElementById('resetFilters').addEventListener('click', () => {
    document.getElementById('filterCompetitor').value = '';
    document.getElementById('filterDateFrom').value   = defaultFrom;
    document.getElementById('filterDateTo').value     = defaultTo;
    document.getElementById('filterProduct').value    = '';
    loadAndRender();
  });

  // â”€â”€ Products filters â”€â”€
  document.getElementById('productsApplyFilters').addEventListener('click', loadAndRenderProducts);
  document.getElementById('productsResetFilters').addEventListener('click', () => {
    document.getElementById('productsFilterCompetitor').value = '';
    document.getElementById('productsFilterDate').value       = '';
    loadAndRenderProducts();
  });

  // â”€â”€ Reviews filters â”€â”€
  document.getElementById('reviewsApplyFilters').addEventListener('click', loadAndRenderReviews);
  document.getElementById('reviewsResetFilters').addEventListener('click', () => {
    document.getElementById('reviewsFilterCompetitor').value = '';
    document.getElementById('reviewsFilterFrom').value       = defaultFrom;
    document.getElementById('reviewsFilterTo').value         = defaultTo;
    loadAndRenderReviews();
  });

  // â”€â”€ Reviews source tabs â”€â”€
  document.querySelectorAll('.source-tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      activeReviewSource = btn.dataset.source;
      document.querySelectorAll('.source-tab-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.source === activeReviewSource);
        b.setAttribute('aria-selected', b.dataset.source === activeReviewSource ? 'true' : 'false');
      });
      loadAndRenderReviews();
    });
  });

  // â”€â”€ Diffs filters â”€â”€
  document.getElementById('diffsApplyFilters').addEventListener('click', loadAndRenderDiffs);
  document.getElementById('diffsResetFilters').addEventListener('click', () => {
    document.getElementById('diffsFilterCompetitor').value = '';
    document.getElementById('diffsFilterFrom').value       = defaultFrom;
    document.getElementById('diffsFilterTo').value         = defaultTo;
    loadAndRenderDiffs();
  });

  // Initial load for pricing tab
  tabLoaded['pricing'] = true;
  await loadAndRender();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
